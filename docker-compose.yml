version: '3.8'

services:
  meilisearch:
    image: getmeili/meilisearch:v1.6
    ports:
      - "7700:7700"
    environment:
      - MEILI_MASTER_KEY=${MEILI_API_KEY:-masterKey}
      # Optimization for Micro Instance (assuming 1GB RAM)
      - MEILI_MAX_INDEXING_MEMORY=300Mb
      - MEILI_MAX_INDEXING_THREADS=1
      - MEILI_NO_ANALYTICS=true
    volumes:
      - meili_data:/meili_data
    restart: unless-stopped

  frontend:
    build: ./frontend
    ports:
      - "8090:80"
    depends_on:
      - dx-unified
    restart: unless-stopped

  dx-unified:
    build: ./backend
    ports:
      - "${PORT:-8080}:8080"
    env_file:
      - ./backend/.env
    environment:
      # Override paths for container
      - PORT=8080
      - GIN_MODE=release
      - DART_DB_PATH=/app/data/dart.db
      - JUDAL_DB_PATH=/app/data/judal.db
      - CANDLE_DATA_DIR=/app/data/candles
      - STORAGE_DIR=/app/storage
      - MEILI_HOST=http://meilisearch:7700
      - TZ=Asia/Seoul
      # Go Runtime Memory Limit (Soft limit for GC)
      - GOMEMLIMIT=300MiB
    volumes:
      - ./backend/data:/app/data
      - ./backend/storage:/app/storage
    depends_on:
      - meilisearch
    restart: unless-stopped

volumes:
  meili_data:
